<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>JAVA</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
	<link rel="manifest" href="manifest.webmanifest">
	<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
	<script src="libs/encoding.js"></script>
	<script type="text/javascript" src="config/default.js" defer></script>
	<script type="text/javascript" src="config/runtests.js" defer></script>
	<script type="text/javascript" src="config/build.js" defer></script>
	<script type="text/javascript" src="config/urlparams.js" defer></script>
	<script type="text/javascript" src="libs/promise-6.0.0.js" defer></script>
	<script type="text/javascript" src="polyfill/IndexedDB-getAll-shim.js" defer></script>
	<script type="text/javascript" src="libs/compiled-method-cache.js" defer></script>
	<script type="text/javascript" src="bld/native.js" defer></script>
	<script type="text/javascript" src="bld/j2me.js" defer></script>
	<script type="text/javascript" src="bld/main-all.js" defer></script>
	<script type="text/javascript" src="kaiads.v5.min.js" defer></script>

	<style>
		body {
			padding: 30px 8px 30px 8px;
			margin: 0px;
		}

		* {
			box-sizing: border-box;
		}

		a {
			text-decoration: none;
			color: #000;
		}

		.header {
			display: block;
			width: 100%;
			padding: 5px 0;
			text-align: center;
			font-size: 1em;
			background-color: black;
			color: #fff;
			position: fixed;
			top: 0;
			left: 0;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap
		}

		.footer {
			width: 100%;
			display: flex;
			text-align: center;
			position: fixed;
			bottom: 0;
			left: 0;
			background-color: black;
		}

		.footerelement {
			display: inline-block;
			width: 33%;
			font-size: 1em;
			font-weight: bold;
			color: #fff;
			padding: 5px 0;
			text-align: center;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap
		}

		.game {
			text-align: center;
			border: 3px solid transparent;
			margin-right: 10px;
			padding: 0px;
			border-radius: 5px;
			text-align: center;
			margin-top: 10px;
			outline-width: 1px;
			outline-color: silver;
			outline-style: solid;
			font-size: 15px;
			padding: 0px;
			width: 63px;
		}

		.game:focus {
			outline-color: transparent;
			border: 3px solid rgb(0, 0, 0);
		}

		.game>.version {
			padding: 0px 15px
		}

		.game:focus>.version {
			background: linear-gradient(#000, #555, #000);
			color: white;
		}


		.menubar {
			position: fixed;
			width: 60%;
			background-color: black;
			left: 0;
			bottom: 31px
		}

		.menuelement {
			width: 100%;
			color: white;
			border: 1px solid #000;
			padding: 5px 3px;
			font-size: 15px
		}

		.menuelement:hover,
		.menuelement:focus {
			background-color: white;
			color: #000;
			cursor: pointer
		}


		.screeninput {
			display: inline-block;
			width: 40%;
			padding: 5px;
			margin: 5px;
			border: 2px solid #ccc;
			border-radius: 5px;
			color: black;
		}

		.screeninput:hover,
		.screeninput:focus {
			background: #8bdcff;
		}
	</style>
</head>

<body>
	<div class="header">Installed Files</div>
	<div class="content">
		<div id="pageContainer" style="display: none;">
			<pre id="consoleContainer"></pre>
			<div id="profilerContainer">
				<div id="profilerToolbar">
					<div class="toolbarLabel">Profiler <span id="profilerMessage" class="toolbarMessage">6
							Seconds</span></div>
					<div id="profilerButtons">
						<div id="profilerStartStop">Start</div>
						<div id="profilerAdjustHeight">Height</div>
					</div>
				</div>
				<div id="profiler">
					<div id="profileList">
					</div>
					<div id="profilePanel">
					</div>
				</div>
			</div>
		</div>


		<pre id="raw-console" style="display: none"></pre>

		<div id="display-container" style="display: none;">
			<div id="display">
				<section id="sidebar" data-type="sidebar" style="display:none">
					<header>
						<h1>Menu</h1>
					</header>
					<nav>
						<ul>
						</ul>
					</nav>
				</section>
				<section id="drawer" role="region">
					<header style="display:none">
						<a href="#"><span class="icon icon-menu">hide sidebar</span></a>
						<a id="header-drawer-button" href="#drawer"><span class="icon icon-menu">show sidebar</span></a>
						<menu id="header-ok-button" type="toolbar" style="display:none"><button>√</button></menu>
						<h1 id="display_title"></h1>
					</header>
					<div id="main" role="main">
						<canvas id="canvas" style="max-width: 100%; max-height: 100%;"></canvas>
						<input id="password-editor" class="text-editor" type="password">
						<input id="tel-editor" class="text-editor" type="tel">
						<input id="number-editor" class="text-editor" type="number">
						<input id="email-editor" class="text-editor" type="email">
						<input id="url-editor" class="text-editor" type="url">
						<div id="textarea-editor" class="text-editor" contenteditable="true"></div>
						<div id="hidden-textarea-editor" class="text-editor"></div>
						<button id="back-button">Back</button>
					</div>
				</section>

				<div id="gamepad" onselectstart='return false' onselect='document.selection.empty()'>
					<div id="padcontent">
						<button>1</button>
						<button>2</button>
						<button>3</button>
						<button>L</button>
						<div></div>
						<button>R</button>
					</div>
					<div id="padcontent">
						<button>4</button>
						<button>5</button>
						<button>6</button>
						<div></div>
						<button>up</button>
					</div>
					<div id="padcontent">
						<button>7</button>
						<button>8</button>
						<button>9</button>
						<button>left</button>
						<button>OK</button>
						<button>right</button>
					</div>
					<div id="padcontent">
						<button>*</button>
						<button>0</button>
						<button>#</button>
						<div></div>
						<button>down</button>
					</div>
				</div>

				<div id="download-screen" class="screen">
					<h1 class="title">Loading ...</h1>
					<div class="download-progress-container">
						<progress class="pack-activity" value="0" max="100"></progress>
					</div>
				</div>

				<div id="splash-screen" class="screen">
					<h1 class="title">Starting midlet…</h1>
					<div class="splash-progress-container">
						<progress></progress>
					</div>
				</div>

				<div id="exit-screen" class="screen">
				</div>

				<div id="background-screen">
				</div>

				<form role="dialog" data-type="confirm" class="lcdui-alert" id="lcdui-alert" style="display: none">
					<section>
						<h1 class="title"></h1>
						<p class="text"></p>
						<p style="border-top: 0"><progress style="display: none"></progress></p>
					</section>
					<menu>
						<button class="button0" style="display: none"></button>
						<button class="button1" style="display: none"></button>
					</menu>
				</form>

				<form role="dialog" data-type="confirm" class="sms-listener-prompt" id="sms-listener-prompt"
					style="display: none">
					<section>
						<h1>SMS Verification</h1>
						<p class="verificationText"></p>
						<input type="text" placeholder="Type SMS Here">
						<p class="timeLeft"></p>
						<progress class="timeLeftBar" value="0" max="100"></progress>
					</section>
					<menu>
						<button class="cancel">Cancel</button>
						<button class="recommend">Done</button>
					</menu>
				</form>

				<form role="dialog" data-type="confirm" class="nokia-fileui-prompt" id="nokia-fileui-prompt"
					style="display: none">
					<section>
						<h1>Select a file</h1>
						<p><input type="file" name="nokia-fileui-file">
					</section>
					<menu>
						<button class="cancel">Cancel</button>
						<button class="recommend">Done</button>
					</menu>
				</form>

				<form role="dialog" data-type="confirm" class="download-failure-dialog" id="download-failure-dialog"
					style="display: none">
					<section>
						<h1 class="download-dialog-text">Download failure</h1>
						<p>The download of midlet failed. Press <i>Retry</i> to try again.</p>
					</section>
					<menu>
						<button class="recommend">Retry</button>
					</menu>
				</form>
			</div>
			<div id="settings">
				<section>
					<table id="counters">
						<tr>
							<td>Bytecode:</td>
							<td><span id="bytecodeCount"></span></td>
						</tr>
						<tr>
							<td>Compiled:</td>
							<td><span id="compiledCount"></span></td>
						</tr>
						<tr>
							<td>Interpreter:</td>
							<td><span id="interpreterCount"></span></td>
						</tr>
						<tr>
							<td>OSR:</td>
							<td><span id="onStackReplacementCount"></span></td>
						</tr>
						<tr>
							<td>Unwind:</td>
							<td><span id="unwindCount"></span></td>
						</tr>
						<tr>
							<td>Preemption:</td>
							<td><span id="preemptionCount"></span></td>
						</tr>
					</table>
				</section>
				<section>
					<select id="loglevel">
						<option value="0">Log Level: Trace
						<option value="1">Log Level: Log
						<option value="2">Log Level: Info
						<option value="3">Log Level: Warn
						<option value="4">Log Level: Error
						<option value="5">Log Level: Silent
					</select>
					<input id="console-filter-input" type="text" placeholder="Filter Console Output" value="">
					<button id="console-clear">Clear console</button>
					<button id="console-save">Save console</button>
					<label><input type="checkbox" id="perfWriter">Perf</label>
				</section>
				<section>
					<button id="exportstorage">Export File System</button>
					<div>Import File System:</div>
					<input type="file" id="importstoragefile">
					<input type="text" id="importstorageurl" placeholder="URL to FS backup">
					<button id="importstorage">Import</button>
					<button id="clearCompiledMethodCache">Clear Compiled Method Cache</button>
					<button id="deleteDatabases">Delete IDB Databases</button>
					<button id="printAllExceptions">Print all exceptions: OFF</button>
					<button id="clearCounters">Clear Counters</button>
					<button id="dumpCounters">Dump Counters</button>
					<button id="sampleCounters1">One sample for 1s</button>
					<button id="sampleCounters2">One sample for 100ms (2s)</button>
					<select id="canvasSize1">
						<option value="" selected>Display size: 240x320</option>
						<option value="size-320x240">Display size: 320x240</option>
						<option value="size-320x480">Display size: 320x480</option>
						<option value="size-480x320">Display size: 480x320</option>
					</select>
					<button id="start">Start</button>

				</section>
			</div>
		</div>
	</div>
	<div class="menubar" style="display: none;" id="menubar">
		<div class="menuelement" onclick="openLocalJar()" tabindex="0">Install</div>
		<div class="menuelement" onclick="clearLocalJar()" tabindex="1">Uninstall All</div>
		<div class="menuelement" tabindex="2" onclick="window.close();">Quit</div>

	</div>
	<div class="footer">
		<div class="footerelement">Menu</div>
		<div class="footerelement">OK</div>
		<div class="footerelement">Exit</div>
	</div>

	<input id="jarFileupload" accept=".jar" multiple="true" type="file" style="visibility: hidden;display:none;" />


	<script type="text/javascript">
		var header = document.getElementsByClassName('header')[0];
		var f1 = document.querySelectorAll('.footerelement')[0];
		var f2 = document.querySelectorAll('.footerelement')[1];
		var f3 = document.querySelectorAll('.footerelement')[2];
		var menubar = document.getElementById('menubar');
		var tmpf3 = '';
		var tmpf2 = '';

		function openmenubar() {
			tmpf3 = f3.innerHTML;
			tmpf2 = f2.innerHTML;
			document.getElementById('menubar').style.display = 'block';
			document.querySelectorAll('.menuelement')[0].focus();
			f1.innerHTML = '';
			f2.innerHTML = 'OK';
			f3.innerHTML = 'Back';
			document.body.style.overflow = 'hidden';
			document.body.removeEventListener('keydown', keydownlisterner);
			document.body.addEventListener('keydown', keydownmenubar);
		}

		function closemenubar() {
			document.body.style.overflow = 'scroll';
			document.getElementById('menubar').style.display = 'none';
			document.body.removeEventListener('keydown', keydownmenubar);
			document.body.addEventListener('keydown', keydownlisterner);
			f3.innerHTML = tmpf3;
			f2.innerHTML = tmpf2;
		}

		function menubarroot(jarName = null, name = 'User Manual') {
			menubar.innerHTML = '<div class="menuelement" onclick="openJar(\'ftu.jar\',\'BookReaderMidlet\');" tabindex="0">Run</div><div class="menuelement" onclick="openLocalJar()" tabindex="1">Install</div><div class="menuelement" onclick="clearLocalJar()" tabindex="2">Uninstall All</div><div class="menuelement" tabindex="3" onclick="window.close();">Quit</div>';
			localStorage.setItem('focusedJar', jarName);
			header.innerHTML = name;
		}
		function menubarnonroot(jarName = null, name = 'User Manual') {
			menubar.innerHTML = '<div class="menuelement" onclick="if(localStorage.getItem(\'focusedJar\') != \'\'){ openJar(localStorage.getItem(\'focusedJar\'), \'\', 1);} else{ alert(\'Please Select One First\');}" tabindex="0">Open</div><div class="menuelement" onclick="setLocalConfig()" tabindex="1">Set Config</div><div class="menuelement" onclick="openLocalJar()" tabindex="2">Install</div><div class="menuelement" onclick="if(localStorage.getItem(\'focusedJar\') != \'\'){deleteLocalJar()} else{ alert(\'Please Select One First\');}" tabindex="3">Uninstall</div><div class="menuelement" onclick="clearLocalJar()" tabindex="4">Reset All</div><div class="menuelement" tabindex="5" onclick="window.close();">Quit</div>';
			localStorage.setItem('focusedJar', jarName);
			header.innerHTML = name;
		}

		function baseFileName(filename) {
			if (!filename) return '';
			var s = filename.split('/');
			return s[s.length - 1];
		}

		function setLocalConfig() {
			var div = document.createElement('div');
			div.id = 'localconfigbar';
			div.innerHTML = '<div style="background: #ddd">Set Screen Size:</div><div style="color: white;"><input type="tel" class="screeninput" tabindex="0" value="0">x<input type="tel" class="screeninput" tabindex="1"  value="0"></div>';
			div.style = "position: fixed;left: 37%;background-color: black;bottom: 105px;border: 2px solid rgb(221, 221, 221);margin-right: 5px;";
			document.body.appendChild(div);
			document.querySelector('.screeninput').focus();
			f2.innerHTML = 'Save';
			f1.innerHTML = '';
			f3.innerHTML = 'Back';
			document.body.removeEventListener('keydown', keydownmenubar);
			document.body.addEventListener('keydown', keydownlocalconfig);
			window.addEventListener('back', (event) => {
				event.preventDefault();
				closeLocalConfig();
			});
		}

		function closeLocalConfig() {
			f1.innerHTML = '';
			f2.innerHTML = 'OK';
			f3.innerHTML = 'Back';
			var configBar = document.querySelector('#localconfigbar');
			if (configBar) {
				document.body.removeChild(configBar);
			}
			document.body.removeEventListener('keydown', keydownlocalconfig);
			document.body.addEventListener('keydown', keydownmenubar);
			window.addEventListener('back', (event) => {
				event.preventDefault();
				closemenubar();
			});
			document.querySelectorAll('.menuelement')[1].focus(); // Focus back on "Set Config"
		}


		function processLocalJAD(data) {
			var manifest = {};
			data.replace(/\r\n|\r/g, "\n").replace(/\n /g, "").split("\n").forEach(function (entry) {
				if (entry) {
					var keyEnd = entry.indexOf(":");
					var key = entry.substring(0, keyEnd);
					var val = entry.substring(keyEnd + 1).trim();
					manifest[key] = val;
				}
			});

			return manifest;
		}

		function refreshGameList() {
			JARStore.getAll().then(
				(files) => {
					var applist = document.getElementById('gamepanel');
					var listapp = ['<a class="game focusable" href="javascript:void(0)" onclick="openJar(\'ftu.jar\',\'BookReaderMidlet\');" tabindex="0" data-name="User Manual" onfocus="menubarroot();"> <div style="height:64px;"> <img src="img/ftu.png" width="50px" height="50px"></img> </div> <div class="version">Help</div></a>'];

					for (var i = 0; i < files.length; i++) {
						var res = files[i];
						var name = baseFileName(res.jarName); // Default name
						var jarVersion = 'N/A';
						var url = 'java.png'; // Default icon

						try {
							var mffile = res.jar['META-INF/MANIFEST.MF'];
							var mfdata = '';
							if (!mffile) throw new Error("MANIFEST.MF not found");

							switch (mffile.compression_method) {
								case 0:
									mfdata = mffile.compressed_data;
									break;
								case 8:
									mfdata = inflate(mffile.compressed_data, mffile.uncompressed_len);
									break;
								default:
									throw new Error("Unsupported compression method for MANIFEST.MF");
							}

							mfdata = new TextDecoder('utf-8').decode(mfdata);
							var dts = processLocalJAD(mfdata);
							var midletInfo = dts['MIDlet-1'];
							jarVersion = dts['MIDlet-Version'] || 'N/A';

							var a = midletInfo.split(',');
							name = a[0].trim();

							var jariconPath = a[1].trim();
							if (jariconPath.startsWith("/")) {
								jariconPath = jariconPath.substring(1);
							}

							var iconfile = res.jar[jariconPath] || res.jar[dts['MIDlet-Icon'] ? dts['MIDlet-Icon'].trim() : ''];
							if (iconfile) {
								var iconfiledata;
								switch (iconfile.compression_method) {
									case 0:
										iconfiledata = iconfile.compressed_data;
										break;
									case 8:
										iconfiledata = new Uint8Array(inflate(iconfile.compressed_data, iconfile.uncompressed_len));
										break;
								}
								if (iconfiledata) {
									var blob = new Blob([iconfiledata], { type: "image/png" });
									url = URL.createObjectURL(blob);
								}
							}

						} catch (err) {
							console.error("Error processing JAR " + res.jarName + ":", err);
						}

						listapp.push(`<a class="game focusable" tabindex="${i + 1}" href="javascript:void(0)" onclick="openJar('${res.jarName}', 0, 1);" data-name="${name}" data-jarName="${res.jarName}" onfocus="menubarnonroot(this.getAttribute('data-jarName'), this.getAttribute('data-name'));"> <div style="height:64px;"> <center><img width="50px" height="50px" src="${url}" onerror="this.src='java.png'"></center> </div><div class="version">${jarVersion}</div></a>`);
					}
					applist.innerHTML = listapp.join('');
				},
				(err) => {
					alert(err);
				}
			);
		}

		function alertSuccess(successcount, failcount) {
			alert('Installation completed, success ' + successcount + ', failure ' + failcount + '.');
		}

		function deleteLocalJar() {
			closemenubar();
			const focusedJar = localStorage.getItem('focusedJar');
			if (!focusedJar || focusedJar === 'null') {
				alert('Please select a game to uninstall.');
				return;
			}
			var res = confirm('Uninstall ' + baseFileName(focusedJar) + '?');
			if (res) {
				JARStore.deleteJar(focusedJar).then(
					() => {
						alert(baseFileName(focusedJar) + ' removed!');
						localStorage.removeItem('focusedJar');
						refreshGameList();
					},
					(errname) => {
						alert('Deletion failed: ' + errname);
					}
				);
			}
		}

		function clearLocalJar() {
			closemenubar();
			var res = confirm('All installed JAR files will be cleared. Are you sure?');
			if (res) {
				JARStore.clear().then(
					() => {
						alert('All JARs cleared!');
						refreshGameList();
					},
					(err) => {
						alert('Could not clear JARs: ' + err);
					}
				);
			}
		}

		var onUploadFile = function (e) {
			closemenubar();
			const _files = e.target.files;
			if (_files.length == 0) return;

			var successcount = 0;
			var failcount = 0;
			var allcount = _files.length;
			var processedCount = 0;

			for (var i = 0; i < _files.length; i++) {
				const _file = _files[i];
				if (!_file.name.toLowerCase().endsWith('.jar')) {
					failcount++;
					processedCount++;
					if (processedCount === allcount) alertSuccess(successcount, failcount);
					continue;
				}
				const reader = new FileReader();
				reader.readAsArrayBuffer(_file);
				reader.onload = function (readRes) {
					JARStore.installJAR(_file.name, readRes.target.result).then(
						() => {
							successcount++;
							processedCount++;
							if (processedCount === allcount) {
								alertSuccess(successcount, failcount);
								refreshGameList();
							}
						},
						(errname) => {
							failcount++;
							processedCount++;
							if (processedCount === allcount) {
								alertSuccess(successcount, failcount);
								refreshGameList();
							}
						}
					);
					document.getElementById('jarFileupload').value = null;
				}
			}
		}

		window.addEventListener('load', () => {
			document.getElementById('jarFileupload').addEventListener('change', onUploadFile);
			refreshGameList();

			// Set up activity handler for opening files
			if ('mozSetMessageHandler' in navigator) {
				navigator.mozSetMessageHandler('activity', function (activityReq) {
					var _file = activityReq.source.data.blob;
					if (!_file) return;

					var reader = new FileReader();
					reader.readAsArrayBuffer(_file);
					reader.onload = function (readRes) {
						JARStore.installJAR(_file.name, readRes.target.result).then(
							() => {
								alertSuccess(1, 0);
								refreshGameList();
							},
							(errname) => {
								alertSuccess(0, 1);
								console.error("Install failed: ", errname);
							}
						);
					}
				});
			}
		});

		function openLocalJar() {
			closemenubar();
			document.getElementById('jarFileupload').click();
		}

		function openJar(jarname, midletClassName, islocaljar) {
			closemenubar();

			var href = 'main.html?jars=jar/' + jarname + '&jad=&midletClassName=' + midletClassName;
			if (islocaljar) {
				href = 'main.html?localjar=' + jarname;
			}

			href += '&gamepad=0';

			const focusedJar = localStorage.getItem('focusedJar');
			const customSize = focusedJar ? localStorage.getItem(focusedJar) : null;

			if (customSize) {
				href += '&canvasSize=size-' + customSize;
			} else {
				href += '&canvasSize=size-no';
			}

			// The gameresize dropdown is hidden, so we hardcode a default or remove it.
			// Let's assume 'resize-1' (None) is the desired default.
			href += '&gameresize=resize-1';

			window.location.href = href;
		}

	

		
	</script>
	<div style="display:flex;flex-wrap: wrap; margin: 10px 0px;float:left;align-items: center;" id="gamepanel">
	</div>

	<!-- Hidden config elements from a previous version -->
	<div style="margin-top: 100px; clear: both;display: none;">
		<select id="canvasSize">
			<option value="size-no" selected>Display size: Any</option>
		</select>
		<select id="gamepadSize">
			<option value="gamepad-0" selected>Virtual Keyboard - None</option>
		</select>
		<select id="gameresize">
			<option value="resize-1" selected>None</option>
		</select>
	</div>


	<script>
		/**
		 * A robust function to handle focus navigation on a list of elements.
		 * @param {number} move - The direction and number of steps to move (e.g., 1, -1, 3, -3).
		 * @param {string} selector - The CSS selector for the focusable items.
		 */
		function robustFocus(move, selector) {
			const items = document.querySelectorAll(selector);
			if (items.length === 0) return;

			var currentIndex = -1;
			for (var i = 0; i < items.length; i++) {
				if (items[i] === document.activeElement) {
					currentIndex = i;
					break;
				}
			}

			if (currentIndex === -1) {
				currentIndex = (move > 0) ? -1 : 0;
			}

			var nextIndex = currentIndex + move;

			// Boundary checks and wrap-around
			if (nextIndex >= items.length) {
				nextIndex = items.length - 1; // Stop at the end
				// Or to wrap around: nextIndex = nextIndex % items.length;
			}
			if (nextIndex < 0) {
				nextIndex = 0; // Stop at the beginning
				// Or to wrap around: nextIndex = items.length - 1;
			}

			const targetElement = items[nextIndex];
			if (targetElement) {
				targetElement.focus();
				// Scrolling into view is important for long lists
				if (selector === '.focusable') {
					targetElement.scrollIntoView({ block: 'center', behavior: 'smooth' });
				}
			}
		}


		// Keydown listener for the main game grid view
		function keydownlisterner(e) {
			switch (e.key) {
				case 'ArrowUp':
					robustFocus(-3, '.focusable');
					e.preventDefault();
					break;
				case 'ArrowDown':
					robustFocus(3, '.focusable');
					e.preventDefault();
					break;
				case 'ArrowLeft':
					robustFocus(-1, '.focusable');
					e.preventDefault();
					break;
				case 'ArrowRight':
					robustFocus(1, '.focusable');
					e.preventDefault();
					break;
				case 'Enter':
					if (document.activeElement && typeof document.activeElement.click === 'function') {
						document.activeElement.click();
					}
					break;
				case 'SoftRight':
				case 'Backspace': // Handle Backspace as an exit key
					localStorage.removeItem('focusedJar');
					window.close();
					break;
				case 'SoftLeft': case 'F1': case 'Escape':
					openmenubar();
					break;
			}
		}

		// Keydown listener when the side menu is open
		function keydownmenubar(e) {
			switch (e.key) {
				case 'ArrowUp':
					robustFocus(-1, '.menuelement');
					e.preventDefault();
					break;
				case 'ArrowDown':
					robustFocus(1, '.menuelement');
					e.preventDefault();
					break;
				case 'Enter':
					if (document.activeElement && typeof document.activeElement.click === 'function') {
						document.activeElement.click();
					}
					break;
				case 'SoftRight':
				case 'Backspace':
					closemenubar();
					break;
			}
		}

		// Keydown listener for the custom screen size config dialog
		function keydownlocalconfig(e) {
			const inputs = document.querySelectorAll('.screeninput');
			switch (e.key) {
				case 'ArrowUp':
				case 'ArrowLeft':
					inputs[0].focus();
					break;
				case 'ArrowDown':
				case 'ArrowRight':
					inputs[1].focus();
					break;
				case 'Enter':
					var w = inputs[0].value.trim();
					var h = inputs[1].value.trim();
					var w_int = parseInt(w, 10);
					var h_int = parseInt(h, 10);

					if (w === '' || h === '' || isNaN(w_int) || isNaN(h_int) || w_int <= 0 || h_int <= 0) {
						if (confirm('This will remove the custom screen size. Continue?')) {
							localStorage.removeItem(localStorage.getItem('focusedJar'));
							alert('Custom size removed.');
							closeLocalConfig();
						} else {
							alert('Please enter valid, non-zero numbers for width and height.');
						}
					} else {
						localStorage.setItem(localStorage.getItem('focusedJar'), w + 'x' + h);
						alert('Screen size set to ' + w + 'x' + h);
						closeLocalConfig();
					}
					break;
				case 'SoftRight':
				case 'Backspace':
					closeLocalConfig();
					break;
			}
		}


		document.body.addEventListener('keydown', keydownlisterner);
		window.addEventListener('back', (event) => {
			event.preventDefault();
			localStorage.removeItem('focusedJar');
			window.close();
		});

		if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js');
}
	</script>
	
</body>

</html>
