<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>JAVA</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
	<script src="libs/encoding.js"></script>
	<script type="text/javascript" src="config/default.js" defer></script>
	<script type="text/javascript" src="config/runtests.js" defer></script>
	<script type="text/javascript" src="config/build.js" defer></script>
	<script type="text/javascript" src="config/urlparams.js" defer></script>
	<script type="text/javascript" src="libs/promise-6.0.0.js" defer></script>
	<script type="text/javascript" src="polyfill/IndexedDB-getAll-shim.js" defer></script>
	<script type="text/javascript" src="libs/compiled-method-cache.js" defer></script>
	<script type="text/javascript" src="bld/native.js" defer></script>
	<script type="text/javascript" src="bld/j2me.js" defer></script>
	<script type="text/javascript" src="bld/main-all.js" defer></script>
	<script type="text/javascript" src="kaiads.v5.min.js" defer></script>

	<style>
		/* Core Layout */
		body {
			padding: 28px 0px 30px 0px;
			margin: 0px;
			background-color: #fff;
			font-family: sans-serif;
			overflow-x: hidden;
		}

		* {
			box-sizing: border-box;
		}

		a {
			text-decoration: none;
			color: #000;
		}

		/* KaiUI Standard Header */
		.header {
			display: block;
			width: 100%;
			height: 28px;
			line-height: 28px;
			text-align: center;
			font-size: 16px;
			font-weight: bold;
			background-color: #873eff; /* KaiOS primary brand color */
			color: #fff;
			position: fixed;
			top: 0;
			left: 0;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			z-index: 100;
		}

		/* KaiUI Standard Softkeys (Footer) */
		.footer {
			width: 100%;
			height: 30px;
			display: flex;
			text-align: center;
			position: fixed;
			bottom: 0;
			left: 0;
			background-color: #cccccc;
		
		}

		.footerelement {
			display: inline-block;
			width: 33.3%;
			font-size: 14px;
			font-weight: 600;
			color: #333;
			line-height: 30px;
			text-align: center;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			text-transform: capitalize;
		}
		
		.footerelement:nth-child(2) {
			font-weight: 700; /* Center key bolder */
			text-transform: uppercase;
		}

		/* Game List */
		.game {
			text-align: center;
			border: 3px solid transparent;
			margin: 5px;
			padding: 0px;
			border-radius: 5px;
			text-align: center;
			margin-top: 10px;
			outline-width: 1px;
			outline-color: silver;
			outline-style: solid;
			font-size: 14px;
			width: 63px;
			display: inline-block;
		}

		.game:focus {
			outline-color: transparent;
			border: 3px solid #873eff;
			background-color: #e2d1ff;
		}

		.game>.version {
			padding: 0px 5px;
			font-size: 11px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		.game:focus>.version {
			background: #873eff;
			color: white;
		}

		/* Menu */
		.menubar {
			position: fixed;
			width: 100%;
			max-height: calc(100% - 58px);
			overflow-y: auto;
			background-color: #fff;
			left: 0;
			bottom: 30px;
			z-index: 50;
			box-shadow: 0px -2px 5px rgba(0,0,0,0.2);
		}

		.menuelement {
			width: 100%;
			color: #000;
			border-bottom: 1px solid #ccc;
			padding: 10px 10px;
			font-size: 16px;
		}

		.menuelement:hover,
		.menuelement:focus {
			background-color: #873eff;
			color: #fff;
			cursor: pointer;
		}

		.screeninput {
			display: inline-block;
			width: 40%;
			padding: 5px;
			margin: 5px;
			border: 2px solid #ccc;
			border-radius: 5px;
			color: black;
		}

		.screeninput:hover,
		.screeninput:focus {
			background: #e2d1ff;
			border-color: #873eff;
		}

		/* KaiUI Tutorial Dialog */
		#tutorial-dialog {
			position: fixed;
			top: 28px;
			left: 0;
			width: 100%;
			height: calc(100% - 58px);
			background-color: #f4f4f4;
			z-index: 9999;
			display: flex;
			flex-direction: column;
		}

		.kai-dialog-title {
			background-color: #e2d1ff;
			color: #000;
			padding: 5px;
			text-align: center;
			font-weight: bold;
			font-size: 16px;
			border-bottom: 1px solid #ccc;
		}

		.kai-dialog-body {
			padding: 10px;
			overflow-y: auto;
			color: #333;
			font-size: 14px;
			flex-grow: 1;
		}

		.kai-dialog-body p {
			margin-top: 0;
			margin-bottom: 8px;
			line-height: 1.3;
		}
	</style>
</head>

<body>
	<div class="header">Installed Files</div>
	<div class="content">
		<div id="pageContainer" style="display: none;">
			<pre id="consoleContainer"></pre>
			<div id="profilerContainer">
				<div id="profilerToolbar">
					<div class="toolbarLabel">Profiler <span id="profilerMessage" class="toolbarMessage">6
							Seconds</span></div>
					<div id="profilerButtons">
						<div id="profilerStartStop">Start</div>
						<div id="profilerAdjustHeight">Height</div>
					</div>
				</div>
				<div id="profiler">
					<div id="profileList"></div>
					<div id="profilePanel"></div>
				</div>
			</div>
		</div>

		<pre id="raw-console" style="display: none"></pre>

		<div id="display-container" style="display: none;">
			<div id="display">
				<!-- System HTML from previous code... -->
				<section id="sidebar" data-type="sidebar" style="display:none">
					<header><h1>Menu</h1></header>
					<nav><ul></ul></nav>
				</section>
				<section id="drawer" role="region">
					<header style="display:none">
						<a href="#"><span class="icon icon-menu">hide sidebar</span></a>
						<a id="header-drawer-button" href="#drawer"><span class="icon icon-menu">show sidebar</span></a>
						<menu id="header-ok-button" type="toolbar" style="display:none"><button>√</button></menu>
						<h1 id="display_title"></h1>
					</header>
					<div id="main" role="main">
						<canvas id="canvas" style="max-width: 100%; max-height: 100%;"></canvas>
						<input id="password-editor" class="text-editor" type="password">
						<input id="tel-editor" class="text-editor" type="tel">
						<input id="number-editor" class="text-editor" type="number">
						<input id="email-editor" class="text-editor" type="email">
						<input id="url-editor" class="text-editor" type="url">
						<div id="textarea-editor" class="text-editor" contenteditable="true"></div>
						<div id="hidden-textarea-editor" class="text-editor"></div>
						<button id="back-button">Back</button>
					</div>
				</section>

				<!-- Other generic UI elements ... -->
			</div>
		</div>
	</div>

	<!-- Tutorial / Disclaimer Screen (KaiUI) -->
	<div id="tutorial-dialog" style="display: none;">
		<div class="kai-dialog-title">Welcome to JAVA ME</div>
		<div class="kai-dialog-body">
			<p><b>Welcome!</b></p>
			<p>This is a Java ME (.jar) emulator.</p>
			<p><b>Controls:</b><br>
			• Use <b>D-Pad</b> to select games.<br>
			• Press <b>Options</b> (Left key) to Install files or adjust settings.<br>
			• Press <b>OK</b> (Center key) to open a game.</p>
			<p><i>Note: Please ensure you own the rights to the JAR files you install.</i></p>
			<p style="text-align:center; margin-top:10px;"><b>Press AGREE to continue</b></p>
		</div>
	</div>

	<div class="menubar" style="display: none;" id="menubar">
		<div class="menuelement" onclick="openLocalJar()" tabindex="0">Install</div>
		<div class="menuelement" onclick="clearLocalJar()" tabindex="1">Uninstall All</div>
		<div class="menuelement" tabindex="2" onclick="window.close();">Quit</div>
	</div>
	
	<div class="footer">
		<div class="footerelement">Menu</div>
		<div class="footerelement">OK</div>
		<div class="footerelement">Exit</div>
	</div>

	<input id="jarFileupload" accept=".jar" multiple="true" type="file" style="visibility: hidden;display:none;" />

	<div style="display:flex;flex-wrap: wrap; margin: 5px;float:left;align-items: center;" id="gamepanel">
	</div>

	<script type="text/javascript">
		var header = document.getElementsByClassName('header')[0];
		var f1 = document.querySelectorAll('.footerelement')[0];
		var f2 = document.querySelectorAll('.footerelement')[1];
		var f3 = document.querySelectorAll('.footerelement')[2];
		var menubar = document.getElementById('menubar');
		var tmpf3 = '';
		var tmpf2 = '';
		var isTutorialActive = false;

		function openmenubar() {
			if (isTutorialActive) return;
			tmpf3 = f3.innerHTML;
			tmpf2 = f2.innerHTML;
			document.getElementById('menubar').style.display = 'block';
			document.querySelectorAll('.menuelement')[0].focus();
			f1.innerHTML = '';
			f2.innerHTML = 'SELECT';
			f3.innerHTML = 'Back';
			document.body.style.overflow = 'hidden';
			document.body.removeEventListener('keydown', keydownlisterner);
			document.body.addEventListener('keydown', keydownmenubar);
		}

		function closemenubar() {
			document.body.style.overflow = 'scroll';
			document.getElementById('menubar').style.display = 'none';
			document.body.removeEventListener('keydown', keydownmenubar);
			document.body.addEventListener('keydown', keydownlisterner);
			f3.innerHTML = tmpf3;
			f2.innerHTML = tmpf2;
			var focusedJar = localStorage.getItem('focusedJar');
			if (focusedJar) {
				var target = document.querySelector(`[data-jarname="${focusedJar}"]`) || document.querySelector('.focusable');
				if (target) target.focus();
			} else {
				var target = document.querySelector('.focusable');
				if (target) target.focus();
			}
		}

		function menubarroot(jarName = null, name = 'User Manual') {
			menubar.innerHTML = '<div class="menuelement" onclick="openJar(\'ftu.jar\',\'BookReaderMidlet\');" tabindex="0">Run</div><div class="menuelement" onclick="openLocalJar()" tabindex="1">Install</div><div class="menuelement" onclick="clearLocalJar()" tabindex="2">Uninstall All</div><div class="menuelement" tabindex="3" onclick="window.close();">Quit</div>';
			localStorage.setItem('focusedJar', jarName);
			header.innerHTML = name;
		}
		function menubarnonroot(jarName = null, name = 'User Manual') {
			menubar.innerHTML = '<div class="menuelement" onclick="if(localStorage.getItem(\'focusedJar\') != \'\'){ openJar(localStorage.getItem(\'focusedJar\'), \'\', 1);} else{ alert(\'Please Select One First\');}" tabindex="0">Open</div><div class="menuelement" onclick="setLocalConfig()" tabindex="1">Set Config</div><div class="menuelement" onclick="openLocalJar()" tabindex="2">Install</div><div class="menuelement" onclick="if(localStorage.getItem(\'focusedJar\') != \'\'){deleteLocalJar()} else{ alert(\'Please Select One First\');}" tabindex="3">Uninstall</div><div class="menuelement" onclick="clearLocalJar()" tabindex="4">Reset All</div><div class="menuelement" tabindex="5" onclick="window.close();">Quit</div>';
			localStorage.setItem('focusedJar', jarName);
			header.innerHTML = name;
		}

		function baseFileName(filename) {
			if (!filename) return '';
			var s = filename.split('/');
			return s[s.length - 1];
		}

		function setLocalConfig() {
			var div = document.createElement('div');
			div.id = 'localconfigbar';
			div.innerHTML = '<div style="background: #e2d1ff; color: #000; padding: 5px; text-align: center; font-weight: bold;">Set Screen Size:</div><div style="background-color: #f4f4f4; padding: 10px; text-align: center;"><input type="tel" class="screeninput" tabindex="0" value="0"> x <input type="tel" class="screeninput" tabindex="1"  value="0"></div>';
			div.style = "position: fixed; width: 100%; background-color: #fff; bottom: 30px; border-top: 2px solid #ccc; z-index: 60;";
			document.body.appendChild(div);
			document.querySelector('.screeninput').focus();
			f2.innerHTML = 'Save';
			f1.innerHTML = '';
			f3.innerHTML = 'Back';
			document.body.removeEventListener('keydown', keydownmenubar);
			document.body.addEventListener('keydown', keydownlocalconfig);
		}

		function closeLocalConfig() {
			f1.innerHTML = '';
			f2.innerHTML = 'SELECT';
			f3.innerHTML = 'Back';
			var configBar = document.querySelector('#localconfigbar');
			if (configBar) {
				document.body.removeChild(configBar);
			}
			document.body.removeEventListener('keydown', keydownlocalconfig);
			document.body.addEventListener('keydown', keydownmenubar);
			document.querySelectorAll('.menuelement')[1].focus(); // Focus back on "Set Config"
		}

		function processLocalJAD(data) {
			var manifest = {};
			data.replace(/\r\n|\r/g, "\n").replace(/\n /g, "").split("\n").forEach(function (entry) {
				if (entry) {
					var keyEnd = entry.indexOf(":");
					var key = entry.substring(0, keyEnd);
					var val = entry.substring(keyEnd + 1).trim();
					manifest[key] = val;
				}
			});
			return manifest;
		}

		function refreshGameList() {
			JARStore.getAll().then(
				(files) => {
					var applist = document.getElementById('gamepanel');
					var listapp = ['<a class="game focusable" href="javascript:void(0)" onclick="openJar(\'ftu.jar\',\'BookReaderMidlet\');" tabindex="0" data-name="User Manual" onfocus="menubarroot();"> <div style="height:64px;"> <img src="img/ftu.png" width="50px" height="50px"></img> </div> <div class="version">Help</div></a>'];
					
					for (var i = 0; i < files.length; i++) {
						var res = files[i];
						var name = baseFileName(res.jarName); // Default name
						var jarVersion = 'N/A';
						var url = 'java.png'; // Default icon

						try {
							var mffile = res.jar['META-INF/MANIFEST.MF'];
							var mfdata = '';
							if (!mffile) throw new Error("MANIFEST.MF not found");

							switch (mffile.compression_method) {
								case 0:
									mfdata = mffile.compressed_data;
									break;
								case 8:
									mfdata = inflate(mffile.compressed_data, mffile.uncompressed_len);
									break;
								default:
								    throw new Error("Unsupported compression method for MANIFEST.MF");
							}

							mfdata = new TextDecoder('utf-8').decode(mfdata);
							var dts = processLocalJAD(mfdata);
							var midletInfo = dts['MIDlet-1'];
							jarVersion = dts['MIDlet-Version'] || 'N/A';
							
							var a = midletInfo.split(',');
							name = a[0].trim();
							
							var jariconPath = a[1].trim();
							if (jariconPath.startsWith("/")) {
								jariconPath = jariconPath.substring(1);
							}
							
							var iconfile = res.jar[jariconPath] || res.jar[dts['MIDlet-Icon'] ? dts['MIDlet-Icon'].trim() : ''];
							if (iconfile) {
								var iconfiledata;
								switch (iconfile.compression_method) {
									case 0:
										iconfiledata = iconfile.compressed_data;
										break;
									case 8:
										iconfiledata = new Uint8Array(inflate(iconfile.compressed_data, iconfile.uncompressed_len));
										break;
								}
								if(iconfiledata){
									var blob = new Blob([iconfiledata], { type: "image/png" });
									url = URL.createObjectURL(blob);
								}
							}
							
						} catch (err) {
							console.error("Error processing JAR " + res.jarName + ":", err);
						}

						listapp.push(`<a class="game focusable" tabindex="${i + 1}" href="javascript:void(0)" onclick="openJar('${res.jarName}', 0, 1);" data-name="${name}" data-jarName="${res.jarName}" onfocus="menubarnonroot(this.getAttribute('data-jarName'), this.getAttribute('data-name'));"> <div style="height:64px;"> <center><img width="50px" height="50px" src="${url}" onerror="this.src='java.png'"></center> </div><div class="version">${jarVersion}</div></a>`);
					}
					applist.innerHTML = listapp.join('');
					
					// Focus logic
					if (!isTutorialActive && document.querySelectorAll('.focusable').length > 0) {
						document.querySelectorAll('.focusable')[0].focus();
					}
				},
				(err) => {
					alert(err);
				}
			);
		}

		function alertSuccess(successcount, failcount) {
			alert('Installation completed, success ' + successcount + ', failure ' + failcount + '.');
		}

		function deleteLocalJar() {
			closemenubar();
			const focusedJar = localStorage.getItem('focusedJar');
			if (!focusedJar || focusedJar === 'null') {
				alert('Please select a game to uninstall.');
				return;
			}
			var res = confirm('Uninstall ' + baseFileName(focusedJar) + '?');
			if (res) {
				JARStore.deleteJar(focusedJar).then(
					() => {
						alert(baseFileName(focusedJar) + ' removed!');
						localStorage.removeItem('focusedJar');
						refreshGameList();
					},
					(errname) => {
						alert('Deletion failed: ' + errname);
					}
				);
			}
		}

		function clearLocalJar() {
			closemenubar();
			var res = confirm('All installed JAR files will be cleared. Are you sure?');
			if (res) {
				JARStore.clear().then(
					() => {
						alert('All JARs cleared!');
						refreshGameList();
					},
					(err) => {
						alert('Could not clear JARs: ' + err);
					}
				);
			}
		}

		var onUploadFile = function (e) {
			closemenubar();
			const _files = e.target.files;
			if (_files.length == 0) return;

			var successcount = 0;
			var failcount = 0;
			var allcount = _files.length;
			var processedCount = 0;

			for (var i = 0; i < _files.length; i++) {
				const _file = _files[i];
				if (!_file.name.toLowerCase().endsWith('.jar')) {
					failcount++;
					processedCount++;
					if(processedCount === allcount) alertSuccess(successcount, failcount);
					continue;
				}
				const reader = new FileReader();
				reader.readAsArrayBuffer(_file);
				reader.onload = function (readRes) {
					JARStore.installJAR(_file.name, readRes.target.result).then(
						() => {
							successcount++;
							processedCount++;
							if (processedCount === allcount) {
								alertSuccess(successcount, failcount);
								refreshGameList();
							}
						},
						(errname) => {
							failcount++;
							processedCount++;
							if (processedCount === allcount) {
								alertSuccess(successcount, failcount);
								refreshGameList();
							}
						}
					);
					document.getElementById('jarFileupload').value = null;
				}
			}
		}

		// First-Time Tutorial checking logic
		function checkTutorial() {
			if (!localStorage.getItem('tutorialSeen')) {
				isTutorialActive = true;
				document.getElementById('tutorial-dialog').style.display = 'flex';
				f1.innerHTML = '';
				f2.innerHTML = 'AGREE';
				f3.innerHTML = 'Not Now';
				// Remove normal listener and restrict to tutorial listener
				document.body.removeEventListener('keydown', keydownlisterner);
				document.body.addEventListener('keydown', keydownTutorial);
                
			} else {
				// Ensure regular listener is on
				document.body.addEventListener('keydown', keydownlisterner);
			}
		}

		function keydownTutorial(e) {
	// Select the scrollable text container inside the tutorial dialog
	var tutorialBody = document.querySelector('.kai-dialog-body');

	switch (e.key) {
		case 'ArrowDown':
			// Scroll Down by 10 pixels
			tutorialBody.scrollBy(0, 30); 
			// Alternatively: tutorialBody.scrollTop += 10;
			e.preventDefault();
			break;

		case 'ArrowUp':
			// Scroll Up by 10 pixels
			tutorialBody.scrollBy(0, -30);
			// Alternatively: tutorialBody.scrollTop -= 10;
			e.preventDefault();
			break;

		case 'Enter':
			// Hide tutorial and save to prevent it from showing again
			localStorage.setItem('tutorialSeen', 'true');
			document.getElementById('tutorial-dialog').style.display = 'none';
			isTutorialActive = false;
			
			// Restore UI Softkeys
			f1.innerHTML = 'Menu';
			f2.innerHTML = 'OK';
			f3.innerHTML = 'Exit';
			
			// Re-attach standard listeners and apply focus
			document.body.removeEventListener('keydown', keydownTutorial);
			document.body.addEventListener('keydown', keydownlisterner);
			if (document.querySelectorAll('.focusable').length > 0) {
				document.querySelectorAll('.focusable')[0].focus();
			}
			break;
            case 'SoftRight': case 'F2':
			window.close();
			e.preventDefault();
			break;
	}
}
		
		window.addEventListener('load', () => {
			document.getElementById('jarFileupload').addEventListener('change', onUploadFile);
			
			// Show tutorial on first launch
			checkTutorial();
			
			// Load game items
			refreshGameList();
			
			// Set up activity handler for opening files
			if ('mozSetMessageHandler' in navigator) {
				navigator.mozSetMessageHandler('activity', function (activityReq) {
					var _file = activityReq.source.data.blob;
					if (!_file) return;

					var reader = new FileReader();
					reader.readAsArrayBuffer(_file);
					reader.onload = function (readRes) {
						JARStore.installJAR(_file.name, readRes.target.result).then(
							() => {
								alertSuccess(1, 0);
								refreshGameList();
							},
							(errname) => {
								alertSuccess(0, 1);
								console.error("Install failed: ", errname);
							}
						);
					}
				});
			}
		});

		function openLocalJar() {
			closemenubar();
			document.getElementById('jarFileupload').click();
		}

		function openJar(jarname, midletClassName, islocaljar) {
			if (isTutorialActive) return;
			closemenubar();

			var href = 'main.html?jars=jar/' + jarname + '&jad=&midletClassName=' + midletClassName;
			if (islocaljar) {
				href = 'main.html?localjar=' + jarname;
			}
			
			href += '&gamepad=0';

			const focusedJar = localStorage.getItem('focusedJar');
			const customSize = focusedJar ? localStorage.getItem(focusedJar) : null;
			
			if (customSize) {
				href += '&canvasSize=size-' + customSize;
			} else {
				href += '&canvasSize=size-no';
			}

			href += '&gameresize=resize-1';
			
			window.location.href = href;
		}

		document.addEventListener('DOMContentLoaded', () => {
			if (typeof getKaiAd === 'function') {
				getKaiAd({
					publisher: '080b82ab-b33a-4763-a498-50f464567e49',
					app: 'java',
					slot: 'java',
					onerror: (err) => console.error('KaiAd Error:', err),
					onready: (ad) => {
						ad.call('display');
					},
				});
			}
		});

		document.body.addEventListener('keyup', (e) => {
			if (e.key === 'Enter' || e.key === 'SoftLeft' || e.key === 'SoftRight') {
				if (typeof getKaiAd === 'function' && !isTutorialActive) {
					getKaiAd({
						publisher: '080b82ab-b33a-4763-a498-50f464567e49',
						app: 'java',
						slot: 'java',
						onerror: (err) => console.error('KaiAd Error:', err),
						onready: (ad) => {
							ad.call('display');
						},
					});
				}
			}
		});

		/**
		 * A robust function to handle focus navigation on a list of elements.
		 */
		function robustFocus(move, selector) {
			const items = document.querySelectorAll(selector);
			if (items.length === 0) return;

			var currentIndex = -1;
			for (var i = 0; i < items.length; i++) {
				if (items[i] === document.activeElement) {
					currentIndex = i;
					break;
				}
			}

			if (currentIndex === -1) {
				currentIndex = (move > 0) ? -1 : 0;
			}

			var nextIndex = currentIndex + move;

			if (nextIndex >= items.length) {
				nextIndex = items.length - 1; 
			}
			if (nextIndex < 0) {
				nextIndex = 0; 
			}
			
			const targetElement = items[nextIndex];
			if (targetElement) {
				targetElement.focus();
				if(selector === '.focusable') {
					targetElement.scrollIntoView({ block: 'center', behavior: 'smooth' });
				}
			}
		}

		// Keydown listener for the main game grid view
		function keydownlisterner(e) {
			if (isTutorialActive) return;
			switch (e.key) {
				case 'ArrowUp':
					robustFocus(-3, '.focusable');
					e.preventDefault();
					break;
				case 'ArrowDown':
					robustFocus(3, '.focusable');
					e.preventDefault();
					break;
				case 'ArrowLeft':
					robustFocus(-1, '.focusable');
					e.preventDefault();
					break;
				case 'ArrowRight':
					robustFocus(1, '.focusable');
					e.preventDefault();
					break;
				case 'Enter':
					if(document.activeElement && typeof document.activeElement.click === 'function') {
						document.activeElement.click();
					}
					break;
				case 'SoftRight':
				case 'Backspace':
					localStorage.removeItem('focusedJar');
					window.close();
					break;
				case 'SoftLeft': case 'F1':
					openmenubar();
					break;
			}
		}

		// Keydown listener when the side menu is open
		function keydownmenubar(e) {
			switch (e.key) {
				case 'ArrowUp':
					robustFocus(-1, '.menuelement');
					e.preventDefault();
					break;
				case 'ArrowDown':
					robustFocus(1, '.menuelement');
					e.preventDefault();
					break;
				case 'Enter':
					if(document.activeElement && typeof document.activeElement.click === 'function') {
						document.activeElement.click();
					}
					break;
				case 'SoftRight':
				case 'Backspace':
					closemenubar();
					break;
			}
		}

		// Keydown listener for the custom screen size config dialog
		function keydownlocalconfig(e) {
			const inputs = document.querySelectorAll('.screeninput');
			switch (e.key) {
				case 'ArrowUp':
				case 'ArrowLeft':
					inputs[0].focus();
					break;
				case 'ArrowDown':
				case 'ArrowRight':
					inputs[1].focus();
					break;
				case 'Enter':
					var w = inputs[0].value.trim();
					var h = inputs[1].value.trim();
					var w_int = parseInt(w, 10);
					var h_int = parseInt(h, 10);

					if (w === '' || h === '' || isNaN(w_int) || isNaN(h_int) || w_int <= 0 || h_int <= 0) {
						if (confirm('This will remove the custom screen size. Continue?')) {
							localStorage.removeItem(localStorage.getItem('focusedJar'));
							alert('Custom size removed.');
							closeLocalConfig();
						} else {
							alert('Please enter valid, non-zero numbers for width and height.');
						}
					} else {
						localStorage.setItem(localStorage.getItem('focusedJar'), w + 'x' + h);
						alert('Screen size set to ' + w + 'x' + h);
						closeLocalConfig();
					}
					break;
				case 'SoftRight':
				case 'Backspace':
					closeLocalConfig();
					break;
			}
		}

	</script>
</body>

</html>
